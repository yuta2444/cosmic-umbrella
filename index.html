<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>めんたいカップ - 団体戦速報</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- CSS Reset & Variables (OKLCH版：アイスランド・パレット) --- */
      :root {
        /* OKLCHの読み方:
               L (Lightness): 0%(黒) 〜 100%(白)
               C (Chroma): 鮮やかさ。0(グレー) 〜 0.4(超鮮やか)
               H (Hue): 色相。0〜360(色相環の角度)
            */

        /* メイン：涼しげな深いグリーン (L=40%付近で重厚感を出す) */
        --primary-color: oklch(40% 0.06 185);

        /* アクセント：落ち着いた赤土色 (L=60%で見やすく、C=0.12で程よい主張) */
        --accent-color: oklch(60% 0.12 35);

        /* 背景：温かみのあるグレイッシュ (H=80付近の黄色みを含ませる) */
        --bg-color: oklch(90% 0.01 80);

        /* カード背景：雪のようなオフホワイト */
        --white: oklch(98% 0.005 80);

        /* テキスト：真っ黒ではなく、深海のようなチャコール */
        --text-color: oklch(30% 0.02 240);

        /* サブテキスト：霧のようなグレー */
        --gray: oklch(55% 0.02 240);

        --font-main: 'Zen Maru Gothic', 'Helvetica Neue', Arial,
          'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-main);
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      /* --- Header --- */
      header {
        background-color: var(--primary-color);
        color: var(--white);
        padding: 1.5rem 1rem;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        letter-spacing: 0.05em;
      }

      header p {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* --- Main Layout --- */
      main {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      /* --- Filter/Search Area (Future expansion) --- */
      .controls {
        margin-bottom: 2rem;
        text-align: right;
      }

      .status-badge {
        display: inline-block;
        background: var(--accent-color); /* デフォルト色 */
        color: white;
        padding: 0.3rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        font-family: var(--font-main); /* 丸ゴシック適用 */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease; /* 色がふわっと変わる */
      }

      /* --- Team Cards Grid --- */
      .ranking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.5rem;
      }

      /* --- Card Design --- */
      .team-card {
        background: var(--white);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-top: 4px solid var(--primary-color);
      }

      .team-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      /* Top 3 Highlighting */
      .rank-1 {
        border-top-color: #ffd700;
        border-width: 6px;
      } /* Gold */
      .rank-2 {
        border-top-color: #c0c0c0;
        border-width: 6px;
      } /* Silver */
      .rank-3 {
        border-top-color: #cd7f32;
        border-width: 6px;
      } /* Bronze */

      .card-header {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .rank-badge {
        background: #333;
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
      }

      .rank-1 .rank-badge {
        background: #ffd700;
        color: #333;
      }
      .rank-2 .rank-badge {
        background: #c0c0c0;
        color: #333;
      }
      .rank-3 .rank-badge {
        background: #cd7f32;
        color: #fff;
      }

      .team-name {
        font-size: 1.1rem;
        font-weight: bold;
        flex-grow: 1;
        margin-left: 0.8rem;
      }

      .team-total {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--accent-color);
      }

      .team-total span {
        font-size: 0.8rem;
        color: var(--gray);
        font-weight: normal;
      }

      /* Members List */
      .members-list {
        padding: 1rem;
      }

      .member-row {
        display: grid;
        /* 変更: 内訳エリア(125px)と合計エリア(50px)を広げました */
        grid-template-columns: 30px 1fr 125px 50px;
        gap: 4px;
        padding: 0.6rem 0;
        border-bottom: 1px dashed #eee;
        align-items: center;
      }

      .member-row:last-child {
        border-bottom: none;
      }

      .position {
        font-size: 0.75rem;
        color: var(--white);
        background-color: var(--gray);
        border-radius: 4px;
        text-align: center;
        padding: 2px 0;
        height: 20px;
        line-height: 20px;
      }

      /* --- 更新ボタンのデザイン --- */
      #reload-btn {
        background-color: var(--white);
        border: 1px solid #ccc;
        color: var(--text-color);
        padding: 0.4rem 0.8rem;
        margin-left: 10px;
        border-radius: 20px;
        cursor: pointer;
        font-family: var(--font-main);
        font-size: 0.9rem;
        font-weight: bold;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      #reload-btn:hover {
        background-color: #eee;
        transform: translateY(-1px);
      }

      #reload-btn:active {
        transform: translateY(1px);
        background-color: #ddd;
      }

      /* アイコンの回転アニメーション */
      @keyframes spin-icon {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .spinning {
        animation: spin-icon 0.8s linear infinite;
        display: inline-block; /* 回転させるために必要 */
      }

      /* 大前：氷河のブルーグリーン (メインカラーと同系色で明るく) */
      .pos-1 {
        background-color: oklch(65% 0.08 190);
      }

      /* 中：岩肌のブルーグレー (彩度Cを下げて無機質に) */
      .pos-2 {
        background-color: oklch(65% 0.03 240);
      }

      /* 落：夕陽のテラコッタ (アクセントカラーと同系色で柔らかく) */
      .pos-3 {
        background-color: oklch(65% 0.1 40);
      }
      /* 名前が長すぎる場合の処理 */
      .player-name {
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 5px;
      }
      .score-details {
        font-size: 0.7rem;
        color: #666;
        text-align: right;
        white-space: nowrap; /* 折り返し防止 */
      }
      .player-score {
        font-weight: bold;
        text-align: right;
        font-size: 1rem;
        color: var(--text-color);
      }

      /* --- ウェルカムスクリーン (スプラッシュ) --- */
      #welcome-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--primary-color); /* 背景色 */
        z-index: 9999; /* 最前面に表示 */
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out; /* フェードアウト用 */
      }

      /* 消えるときのクラス */
      #welcome-screen.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none; /* 下のボタンを押せるようにする */
      }

      .welcome-content {
        text-align: center;
        color: var(--white);
      }

      .welcome-text {
        margin-top: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        font-family: var(--font-main);
        opacity: 0;
        animation: fadeIn 0.5s ease-out 0.8s forwards; /* 画像の後に文字が出る */
      }

      /* --- 頂いたアニメーション設定 (poyon) --- */
      .poyon-img {
        /* 画像サイズ調整（必要に応じて変更してください） */
        width: 120px;
        height: auto;

        /* アニメーション適用 */
        animation: poyon 1.1s linear 0s 1 normal forwards;
      }

      @keyframes poyon {
        0% {
          transform: scale(0.8, 1.4) translate(0%, -100%);
          opacity: 0;
        }
        10% {
          transform: scale(0.8, 1.4) translate(0%, -15%);
          opacity: 1;
        }
        20% {
          transform: scale(1.4, 0.6) translate(0%, 30%);
        }
        30% {
          transform: scale(0.9, 1.1) translate(0%, -10%);
        }
        40% {
          transform: scale(0.95, 1.2) translate(0%, -30%);
        }
        50% {
          transform: scale(0.95, 1.2) translate(0%, -10%);
        }
        60% {
          transform: scale(1.1, 0.9) translate(0%, 5%);
        }
        70% {
          transform: scale(1, 1) translate(0%, 0%);
        }
        100% {
          transform: scale(1, 1) translate(0%, 0%);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Footer --- */
      footer {
        text-align: center;
        padding: 2rem;
        color: var(--gray);
        font-size: 0.8rem;
        margin-top: 3rem;
        border-top: 1px solid #ddd;
      }

      /* --- Loading / Error States --- */
      #loading,
      #error-msg {
        text-align: center;
        padding: 3rem;
        font-weight: bold;
        color: var(--gray);
      }
      #error-msg {
        color: var(--accent-color);
        display: none;
      }

      /* --- Mobile Optimization --- */
      @media (max-width: 600px) {
        .ranking-grid {
          grid-template-columns: 1fr; /* Full width cards on mobile */
        }
        header h1 {
          font-size: 1.2rem;
        }
        .team-total {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="welcome-screen">
      <div class="welcome-content">
        <img src="images/matomentaiko.png" alt="Logo" class="poyon-img" />
        <p class="welcome-text">めんたいカップ２０２６</p>
      </div>
    </div>
    <header>
      <h1>めんたいカップ２０２６成績閲覧ページへようこそ</h1>
      <p>
        最新のスコアと成績をチェックし、大会のハイライトや参加選手のパフォーマンスを見つけましょう
      </p>
    </header>

    <main>
      <div class="controls">
        <span class="status-badge">状況確認中...</span>

        <button id="reload-btn" onclick="manualReload()">
          <span id="reload-icon">↻</span> 更新
        </button>

        <span style="margin-left: 10px; font-size: 0.9rem"
          >最終更新: <span id="last-updated">--:--</span></span
        >
      </div>

      <div id="loading">データを読み込んでいます...</div>
      <div id="error-msg">データの取得に失敗しました。</div>

      <div id="app" class="ranking-grid" style="display: none"></div>
    </main>

    <footer>&copy; MentaiCup HeadQuarters. All rights reserved.</footer>

    <script>
      // エラーログを収集するためのラッパー関数
      function logError(message, details = null) {
        console.error(`[Tournament App Error]: ${message}`, details);
        // 必要であればここに管理者に通知を送る処理を追加可能
      }

      // ヘルパー関数: 数値なら「中」をつける、それ以外（ハイフンなど）ならそのまま返す
      function formatScore(value) {
        // valueが数値、もしくは数字の文字列なら "中" をつける
        if (value !== '-' && value !== '' && !isNaN(value)) {
          return `${value}中`;
        }
        return value; // "-" などの場合はそのまま返す
      }

      // チームカードのHTMLを生成する関数（修正版）
      function createTeamCard(team) {
        try {
          const rankClass = team.rank <= 3 ? `rank-${team.rank}` : '';

          const membersHtml = team.members
            .map(
              (member) => `
                <div class="member-row">
                    <span class="position ${
                      member.posClass
                    }">${member.position.charAt(0)}</span>

                    <span class="player-name">${member.name}</span>

                    <span class="score-details">
                        ${formatScore(member.details.s1)} - ${formatScore(
                member.details.s2
              )} - ${formatScore(member.details.s3)}
                    </span>

                    <span class="player-score">${formatScore(
                      member.score
                    )}</span>
                </div>
            `
            )
            .join('');

          return `
                <article class="team-card ${rankClass}">
                    <div class="card-header">
                        <div class="rank-badge">${team.rank}</div>
                        <div class="team-name">${team.teamName}</div>
                        <div class="team-total">${team.totalScore}<span>中</span></div>
                    </div>
                    <div class="members-list">
                        ${membersHtml}
                    </div>
                </article>
            `;
        } catch (e) {
          logError('Card creation failed for team', team);
          return '';
        }
      }
      // メイン描画処理
      async function initApp() {
        const appContainer = document.getElementById('app');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-msg');
        const lastUpdatedEl = document.getElementById('last-updated');

        const API_URL =
          'https://script.google.com/macros/s/AKfycbxM8Bfr9i8uQVFp0NSjluD3pIRyDgS1Yi999rGG30dmiz6zUyMeGkzF41XefC6cQQ1XQA/exec';

        try {
          // STEP 1: データ取得 (GAS APIへリクエスト)
          const response = await fetch(API_URL, {
            method: 'GET',
            mode: 'cors', // CORS通信であることを明示
            headers: {
              'Content-Type': 'text/plain;charset=utf-8',
            },
            redirect: 'follow', // GASのリダイレクト（302）を追跡する
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const json = await response.json();

          // GAS側でエラーが起きている場合のチェック
          if (json.status === 'error')
            throw new Error(json.error || 'Server side error');

          // --- ⬇︎ ★追加・修正：ステータスの表示更新処理 ⬇︎ ---
          const badgeEl = document.querySelector('.status-badge');

          // GASからステータスが送られてきているかチェック
          if (badgeEl && json.tournamentStatus) {
            const statusText = json.tournamentStatus;
            badgeEl.textContent = statusText;

            // ステータスに合わせて色を変える（UX向上）
            if (statusText.includes('終了')) {
              badgeEl.style.backgroundColor = 'var(--gray)'; // グレー
            } else if (statusText.includes('休憩')) {
              badgeEl.style.backgroundColor = '#D4A017'; // 休憩はゴールド/黄色系
            } else {
              badgeEl.style.backgroundColor = 'var(--accent-color)'; // 進行中は赤（アクセントカラー）
            }
          }

          const data = json.data;

          // データが空の場合のチェック
          if (!data || data.length === 0) {
            throw new Error('現在、表示できるデータがありません');
          }

          // STEP 2: HTML生成
          const cardsHtml = data.map((team) => createTeamCard(team)).join('');

          // STEP 3: DOM更新
          appContainer.innerHTML = cardsHtml;

          // 更新時刻のセット（GASから返ってきた時刻を使用）
          lastUpdatedEl.textContent = json.lastUpdate || '--:--';

          // 表示切り替え
          loadingEl.style.display = 'none';
          appContainer.style.display = 'grid';
        } catch (error) {
          logError('Initialization failed', error);
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorEl.textContent = `読み込みエラー: ${error.message}`; // ユーザーに見せるメッセージ
        }
      }
      // ★追加：手動リロードボタンの処理
      async function manualReload() {
        const btn = document.getElementById('reload-btn');
        const icon = document.getElementById('reload-icon');

        // 1. ボタンを一時的に無効化（連打防止）
        btn.disabled = true;

        // 2. アイコンを回す
        icon.classList.add('spinning');

        // 3. データを再取得 (既存のinitApp関数を呼ぶ)
        await initApp();

        // 4. 少し待ってからアニメーションを止める（早すぎると残像感がないため）
        setTimeout(() => {
          icon.classList.remove('spinning');
          btn.disabled = false;
        }, 500);
      }

      // DOM読み込み完了後に実行
      document.addEventListener('DOMContentLoaded', () => {
        // 1. まずデータを読み込み開始（裏側でやっておく）
        initApp();

        // 2. ウェルカムスクリーンの制御
        // アニメーション(1.1秒) + 文字表示などの余韻を含めて 2.5秒後に消す
        setTimeout(() => {
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.classList.add('hidden');
          }
        }, 2500); // 2500ミリ秒 = 2.5秒
      });
    </script>
  </body>
</html>
