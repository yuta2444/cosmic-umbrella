<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>チーム成績入力 - 第4回めんたいこ杯</title>
    <style>
      /* --- CSS Reset & Variables (OKLCH Ice Theme) --- */
      :root {
        --primary-color: oklch(40% 0.06 185);
        --accent-color: oklch(60% 0.12 35);
        --bg-color: oklch(90% 0.01 80);
        --white: oklch(98% 0.005 80);
        --text-color: oklch(30% 0.02 240);
        --gray: oklch(65% 0.02 240);
        --font-main: 'Helvetica Neue', Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: var(--font-main);
        background-color: var(--bg-color);
        color: var(--text-color);
        padding-bottom: 50px;
      }

      header {
        background: var(--primary-color);
        color: var(--white);
        padding: 1rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      header h1 {
        font-size: 1.2rem;
      }

      .tabs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        background: var(--white);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .tab-btn {
        padding: 1rem 0;
        border: none;
        background: transparent;
        font-weight: bold;
        color: var(--gray);
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: oklch(96% 0.01 185);
      }

      .player-list {
        max-width: 800px;
        margin: 1rem auto;
        padding: 0 1rem;
      }

      /* チーム単位のカードスタイルに変更 */
      .team-card-input {
        background: var(--white);
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        border-left: 5px solid var(--accent-color);
        cursor: pointer; /* クリック可能を示唆 */
        transition: transform 0.1s;
      }
      .team-card-input:active {
        transform: scale(0.99);
        background: #f0f0f0;
      }

      .team-header-row {
        padding: 0.8rem 1rem;
        background: rgba(0, 0, 0, 0.02);
        font-weight: bold;
        color: var(--primary-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .edit-icon {
        font-size: 0.8rem;
        background: var(--primary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
      }

      .player-row {
        padding: 0.8rem 1rem;
        border-bottom: 1px dashed #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .player-row:last-child {
        border-bottom: none;
      }

      .p-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .p-pos {
        font-size: 0.7rem;
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--gray);
        min-width: 25px;
        text-align: center;
      }
      .pos-1 {
        background-color: oklch(65% 0.08 190);
      }
      .pos-2 {
        background-color: oklch(65% 0.03 240);
      }
      .pos-3 {
        background-color: oklch(65% 0.1 40);
      }

      .p-score {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--text-color);
      }
      .p-score.empty {
        color: #ccc;
      }

      /* モーダル (3人入力用) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .modal-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-card {
        background: var(--white);
        width: 95%;
        max-width: 500px;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-title {
        margin-bottom: 1rem;
        font-size: 1.1rem;
        color: var(--primary-color);
        text-align: center;
        font-weight: bold;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
      }

      /* モーダル内の各選手行 */
      .input-row {
        margin-bottom: 1.5rem;
      }
      .input-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 0.5rem;
        font-weight: bold;
        font-size: 0.95rem;
      }

      /* ボタン群 */
      .btn-group {
        display: flex;
        gap: 5px;
        justify-content: space-between;
      }
      .score-select-btn {
        flex: 1;
        padding: 0.8rem 0;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--gray);
        cursor: pointer;
      }
      /* 選択されたボタン */
      .score-select-btn.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      /* アクションボタン */
      .modal-actions {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .action-btn {
        padding: 1rem;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-cancel {
        background: #eee;
        color: #666;
      }
      .btn-save {
        background: var(--accent-color);
        color: white;
      }

      /* Loading */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
        display: none;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--gray);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .loading-text {
        margin-top: 10px;
        font-weight: bold;
        color: var(--primary-color);
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>成績入力システム</h1>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('s1')">1手目</button>
      <button class="tab-btn" onclick="switchTab('s2')">午前の立</button>
      <button class="tab-btn" onclick="switchTab('s3')">午後の立</button>
    </div>

    <main id="list-container" class="player-list">
      <div style="text-align: center; padding: 2rem">読み込み中...</div>
    </main>

    <div id="modal" class="modal-overlay">
      <div class="modal-card">
        <h3 id="modal-team-name" class="modal-title">チーム名</h3>
        <div id="modal-inputs-container"></div>
        <div class="modal-actions">
          <button class="action-btn btn-cancel" onclick="closeModal()">
            キャンセル
          </button>
          <button class="action-btn btn-save" onclick="submitTeamScores()">
            一括保存
          </button>
        </div>
      </div>
    </div>

    <div id="loading-overlay">
      <div class="spinner"></div>
      <div id="loading-msg" class="loading-text">送信中...</div>
    </div>

    <script>
      // ★ GASのウェブアプリURLをここに貼ってください
      const API_URL = 'https://script.google.com/macros/s/あなたのID/exec';

      let allData = [];
      let currentTab = 's1';
      let selectedTeam = null; // 選択中のチーム
      let tempScores = {}; // 入力中のスコア一時保存用 { "選手名": 点数 }
      let authKey = '';

      const tabConfig = {
        s1: { label: '1手目', max: 2 },
        s2: { label: '午前の立', max: 4 },
        s3: { label: '午後の立', max: 4 },
      };

      async function init() {
        authKey = prompt('管理者用パスワードを入力してください', '');
        if (!authKey) alert('パスワードがないため、閲覧モードになります');

        showLoading(true, 'データを読み込んでいます...');
        try {
          const res = await fetch(API_URL);
          const json = await res.json();
          if (json.status === 'success') {
            allData = json.data;
            renderList();
          } else {
            alert('データの取得に失敗しました');
          }
        } catch (e) {
          console.error(e);
          alert('通信エラー');
        }
        showLoading(false);
      }

      window.switchTab = function (tabKey) {
        currentTab = tabKey;
        document
          .querySelectorAll('.tab-btn')
          .forEach((btn) => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderList();
      };

      // ★チーム単位でリストを表示
      function renderList() {
        const container = document.getElementById('list-container');
        container.innerHTML = '';

        allData.forEach((team) => {
          // チームカードを作成
          const card = document.createElement('div');
          card.className = 'team-card-input';

          // チーム名ヘッダー
          const header = document.createElement('div');
          header.className = 'team-header-row';
          header.innerHTML = `
                <span>${team.teamName}</span>
                <span class="edit-icon">入力する</span>
            `;
          card.appendChild(header);

          // メンバー行（表示のみ）
          team.members.forEach((member) => {
            let score = member.details[currentTab];
            if (score === null || score === '') score = '-';

            const scoreClass = score === '-' ? 'empty' : '';
            const displayScore = score === '-' ? '未' : `${score}中`;

            const row = document.createElement('div');
            row.className = 'player-row';
            row.innerHTML = `
                    <div class="p-info">
                        <span class="p-pos ${
                          member.posClass
                        }">${member.position.charAt(0)}</span>
                        <span class="p-name">${member.name}</span>
                    </div>
                    <div class="p-score ${scoreClass}">${displayScore}</div>
                `;
            card.appendChild(row);
          });

          // カード全体をクリックしたらモーダルを開く
          card.onclick = () => openTeamModal(team);
          container.appendChild(card);
        });
      }

      // ★3人入力用モーダルを開く
      function openTeamModal(team) {
        selectedTeam = team;
        tempScores = {}; // リセット

        document.getElementById(
          'modal-team-name'
        ).textContent = `${team.teamName} (${tabConfig[currentTab].label})`;
        const container = document.getElementById('modal-inputs-container');
        container.innerHTML = '';

        const maxScore = tabConfig[currentTab].max;

        // メンバーごとにループして入力欄を作る
        team.members.forEach((member) => {
          // 現在のスコアを取得（初期値）
          let currentVal = member.details[currentTab];
          // 数値でなければ null扱い
          if (currentVal === '-' || currentVal === '') currentVal = null;
          else currentVal = Number(currentVal);

          // 一時保存にもセット
          tempScores[member.name] = currentVal;

          const wrapper = document.createElement('div');
          wrapper.className = 'input-row';

          // 名前ラベル
          const label = document.createElement('div');
          label.className = 'input-label';
          label.innerHTML = `<span class="p-pos ${
            member.posClass
          }">${member.position.charAt(0)}</span> ${member.name}`;
          wrapper.appendChild(label);

          // ボタン群
          const btnGroup = document.createElement('div');
          btnGroup.className = 'btn-group';

          for (let i = 0; i <= maxScore; i++) {
            const btn = document.createElement('button');
            btn.className = 'score-select-btn';
            if (currentVal === i) btn.classList.add('selected'); // 初期値選択
            btn.textContent = i;

            // ボタンクリック時
            btn.onclick = (e) => {
              // 他のボタンの選択を外す
              const parent = e.target.parentNode;
              Array.from(parent.children).forEach((b) =>
                b.classList.remove('selected')
              );
              // 自分を選択
              e.target.classList.add('selected');
              // スコア記録
              tempScores[member.name] = i;
            };

            btnGroup.appendChild(btn);
          }
          wrapper.appendChild(btnGroup);
          container.appendChild(wrapper);
        });

        document.getElementById('modal').classList.add('open');
      }

      window.closeModal = function () {
        document.getElementById('modal').classList.remove('open');
        selectedTeam = null;
      };

      // ★一括保存処理
      async function submitTeamScores() {
        if (!authKey) {
          alert('パスワード未入力のため保存できません。');
          return;
        }

        // 入力されているスコアだけ抽出して送信リストを作る
        const updates = [];
        selectedTeam.members.forEach((member) => {
          const val = tempScores[member.name];
          // null(未選択)でなければ送信対象にする
          if (val !== null && val !== undefined) {
            updates.push({
              id: selectedTeam.id,
              name: member.name,
              target: currentTab,
              score: val,
              authKey: authKey,
            });
          }
        });

        if (updates.length === 0) {
          closeModal();
          return;
        }

        showLoading(true, '保存中(0/' + updates.length + ')...');
        closeModal(); // 先に閉じる

        // ★重要: 1件ずつ順番に送信する (GASのロック競合を防ぐため)
        let successCount = 0;
        let errorOccurred = false;

        for (let i = 0; i < updates.length; i++) {
          updateLoadingMsg(`保存中(${i + 1}/${updates.length})...`);

          try {
            const payload = updates[i];
            const res = await fetch(API_URL, {
              method: 'POST',
              body: JSON.stringify(payload),
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            });
            const json = await res.json();

            if (json.status === 'success') {
              // ローカルデータ更新
              updateLocalData(
                payload.id,
                payload.name,
                payload.target,
                payload.score
              );
              successCount++;
            } else {
              console.error('Save failed for ' + payload.name, json.message);
              errorOccurred = true;
            }
          } catch (e) {
            console.error(e);
            errorOccurred = true;
          }
        }

        showLoading(false);

        if (errorOccurred) {
          alert(
            `完了しましたが、いくつかのデータ保存に失敗しました。\n成功: ${successCount} / ${updates.length}\n画面を確認してください。`
          );
        } else {
          // alert("保存しました"); // いちいち出すとウザいので省略しても良い
        }

        // リスト再描画
        renderList();
      }

      function updateLocalData(tid, pname, target, val) {
        const team = allData.find((t) => t.id === tid);
        if (team) {
          const mem = team.members.find((m) => m.name === pname);
          if (mem) mem.details[target] = val;
        }
      }

      function showLoading(show, msg = '') {
        const el = document.getElementById('loading-overlay');
        const txt = document.getElementById('loading-msg');
        el.style.display = show ? 'flex' : 'none';
        if (msg) txt.textContent = msg;
      }

      function updateLoadingMsg(msg) {
        document.getElementById('loading-msg').textContent = msg;
      }

      init();
    </script>
  </body>
</html>
