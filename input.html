<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>成績・進行管理 - 第4回めんたいこ杯</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- CSS Reset & Variables (OKLCH Ice Theme) --- */
      :root {
        --primary-color: oklch(40% 0.06 185);
        --accent-color: oklch(60% 0.12 35);
        --bg-color: oklch(90% 0.01 80);
        --white: oklch(98% 0.005 80);
        --text-color: oklch(30% 0.02 240);
        --gray: oklch(65% 0.02 240);
        --font-main: 'Zen Maru Gothic', 'Helvetica Neue', Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: var(--font-main);
        background-color: var(--bg-color);
        color: var(--text-color);
        padding-bottom: 50px;
      }

      header {
        background: var(--primary-color);
        color: var(--white);
        padding: 1rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      header h1 {
        font-size: 1.2rem;
        margin: 0;
      }

      /* タブのレイアウト：4つに変更 */
      .tabs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        background: var(--white);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .tab-btn {
        padding: 1rem 0;
        border: none;
        background: transparent;
        font-weight: bold;
        color: var(--gray);
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        font-family: var(--font-main);
        font-size: 0.9rem;
      }
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: oklch(96% 0.01 185);
      }
      .tab-btn.settings-tab {
        color: var(--text-color);
      }

      .player-list {
        max-width: 800px;
        margin: 1rem auto;
        padding: 0 1rem;
      }

      /* チームカード */
      .team-card-input {
        background: var(--white);
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        border-left: 5px solid var(--accent-color);
        cursor: pointer;
        transition: transform 0.1s;
      }
      .team-card-input:active {
        transform: scale(0.99);
        background: #f0f0f0;
      }

      .team-header-row {
        padding: 0.8rem 1rem;
        background: rgba(0, 0, 0, 0.02);
        font-weight: bold;
        color: var(--primary-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tachijun-badge {
        display: inline-block;
        background-color: var(--gray);
        color: white;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 8px;
        font-family: monospace;
      }
      .edit-icon {
        font-size: 0.8rem;
        background: var(--primary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
      }

      .player-row {
        padding: 0.8rem 1rem;
        border-bottom: 1px dashed #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .player-row:last-child {
        border-bottom: none;
      }

      .p-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .p-pos {
        font-size: 0.7rem;
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--gray);
        min-width: 25px;
        text-align: center;
      }
      .pos-1 {
        background-color: oklch(65% 0.08 190);
      }
      .pos-2 {
        background-color: oklch(65% 0.03 240);
      }
      .pos-3 {
        background-color: oklch(65% 0.1 40);
      }

      .p-score {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--text-color);
      }
      .p-score.empty {
        color: #ccc;
      }

      /* --- 設定画面のスタイル --- */
      #settings-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
        display: none; /* 初期状態は非表示 */
        text-align: center;
      }
      .status-btn-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      .status-btn {
        padding: 1.5rem;
        font-size: 1.1rem;
        font-weight: bold;
        border: 2px solid #ddd;
        background: var(--white);
        color: var(--text-color);
        border-radius: 12px;
        cursor: pointer;
        font-family: var(--font-main);
        transition: all 0.2s;
      }
      .status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      /* アクティブなステータス */
      .status-btn.active {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
        box-shadow: 0 0 15px rgba(53, 92, 88, 0.4);
      }

      /* モーダル */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .modal-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-card {
        background: var(--white);
        width: 95%;
        max-width: 500px;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-title {
        margin-bottom: 1rem;
        font-size: 1.1rem;
        color: var(--primary-color);
        text-align: center;
        font-weight: bold;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
      }
      .input-row {
        margin-bottom: 1.5rem;
      }
      .input-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 0.5rem;
        font-weight: bold;
        font-size: 0.95rem;
      }

      .btn-group {
        display: flex;
        gap: 5px;
        justify-content: space-between;
      }
      .score-select-btn {
        flex: 1;
        padding: 0.8rem 0;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--gray);
        cursor: pointer;
        font-family: var(--font-main);
      }
      .score-select-btn.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .modal-actions {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .action-btn {
        padding: 1rem;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
        font-family: var(--font-main);
      }
      .btn-cancel {
        background: #eee;
        color: #666;
      }
      .btn-save {
        background: var(--accent-color);
        color: white;
      }

      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
        display: none;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--gray);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .loading-text {
        margin-top: 10px;
        font-weight: bold;
        color: var(--primary-color);
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>成績・進行管理</h1>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('s1')">1手目</button>
      <button class="tab-btn" onclick="switchTab('s2')">午前</button>
      <button class="tab-btn" onclick="switchTab('s3')">午後</button>
      <button class="tab-btn settings-tab" onclick="switchTab('settings')">
        ⚙️設定
      </button>
    </div>

    <main id="list-container" class="player-list">
      <div style="text-align: center; padding: 2rem">読み込み中...</div>
    </main>

    <main id="settings-container">
      <h3>大会ステータスの変更</h3>
      <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 1rem">
        現在の進行状況を選択してください。<br />閲覧ページ（index.html）に反映されます。
      </p>

      <div class="status-btn-grid">
        <button class="status-btn" onclick="updateStatus('予選進行中')">
          予選進行中
        </button>
        <button class="status-btn" onclick="updateStatus('昼休憩')">
          昼休憩
        </button>
        <button class="status-btn" onclick="updateStatus('決勝進行中')">
          決勝進行中
        </button>
        <button class="status-btn" onclick="updateStatus('大会終了')">
          大会終了
        </button>
      </div>
    </main>

    <div id="modal" class="modal-overlay">
      <div class="modal-card">
        <h3 id="modal-team-name" class="modal-title">チーム名</h3>
        <div id="modal-inputs-container"></div>
        <div class="modal-actions">
          <button class="action-btn btn-cancel" onclick="closeModal()">
            キャンセル
          </button>
          <button class="action-btn btn-save" onclick="submitTeamScores()">
            一括保存
          </button>
        </div>
      </div>
    </div>

    <div id="loading-overlay">
      <div class="spinner"></div>
      <div id="loading-msg" class="loading-text">送信中...</div>
    </div>

    <script>
      // ★ GASのウェブアプリURLをここに貼ってください
      const API_URL = 'https://script.google.com/macros/s/あなたのID/exec';

      let allData = [];
      let currentTab = 's1';
      let selectedTeam = null;
      let tempScores = {};
      let authKey = '';
      let currentStatus = ''; // 現在のステータス

      const tabConfig = {
        s1: { label: '1手目', max: 2 },
        s2: { label: '午前の立', max: 4 },
        s3: { label: '午後の立', max: 4 },
      };

      async function init() {
        authKey = prompt('管理者用パスワードを入力してください', '');
        if (!authKey) alert('パスワードがないため、閲覧モードになります');

        showLoading(true, 'データを読み込んでいます...');
        try {
          const res = await fetch(API_URL);
          const json = await res.json();

          if (json.status === 'success') {
            allData = json.data;
            currentStatus = json.tournamentStatus; // ステータス保持

            // 立順昇順ソート
            allData.sort((a, b) => (a.tachijun || 0) - (b.tachijun || 0));

            renderList();
            highlightCurrentStatus(); // 設定画面のボタンを光らせる
          } else {
            alert('データの取得に失敗しました');
          }
        } catch (e) {
          console.error(e);
          alert('通信エラー');
        }
        showLoading(false);
      }

      // タブ切り替え
      window.switchTab = function (tabKey) {
        currentTab = tabKey;

        // タブの見た目
        document
          .querySelectorAll('.tab-btn')
          .forEach((btn) => btn.classList.remove('active'));
        event.target.classList.add('active');

        // 表示エリアの切り替え
        const listContainer = document.getElementById('list-container');
        const settingsContainer = document.getElementById('settings-container');

        if (tabKey === 'settings') {
          listContainer.style.display = 'none';
          settingsContainer.style.display = 'block';
        } else {
          listContainer.style.display = 'block';
          settingsContainer.style.display = 'none';
          renderList(); // リスト再描画
        }
      };

      // ステータス更新処理
      window.updateStatus = async function (newStatus) {
        if (!authKey) {
          alert('パスワード未入力のため変更できません。');
          return;
        }

        if (!confirm(`ステータスを「${newStatus}」に変更しますか？`)) return;

        showLoading(true, '設定を更新中...');

        const payload = {
          action: 'update_status', // ★重要: ステータス更新アクション
          status: newStatus,
          authKey: authKey,
        };

        try {
          const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          });
          const json = await res.json();

          if (json.status === 'success') {
            currentStatus = newStatus;
            highlightCurrentStatus();
            alert('変更しました！');
          } else {
            alert('失敗しました: ' + json.message);
          }
        } catch (e) {
          console.error(e);
          alert('通信エラー');
        }
        showLoading(false);
      };

      // 現在のステータスのボタンをハイライト
      function highlightCurrentStatus() {
        const btns = document.querySelectorAll('.status-btn');
        btns.forEach((btn) => {
          if (btn.textContent === currentStatus) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      // リスト描画
      function renderList() {
        const container = document.getElementById('list-container');
        container.innerHTML = '';

        allData.forEach((team) => {
          const card = document.createElement('div');
          card.className = 'team-card-input';

          const header = document.createElement('div');
          header.className = 'team-header-row';

          const tachijunNum = team.tachijun || '-';

          header.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="tachijun-badge">${tachijunNum}</span>
                    <span>${team.teamName}</span>
                </div>
                <span class="edit-icon">入力</span>
            `;
          card.appendChild(header);

          team.members.forEach((member) => {
            let score = member.details[currentTab];
            if (score === null || score === '') score = '-';
            const scoreClass = score === '-' ? 'empty' : '';
            const displayScore = score === '-' ? '未' : `${score}中`;

            const row = document.createElement('div');
            row.className = 'player-row';
            row.innerHTML = `
                    <div class="p-info">
                        <span class="p-pos ${
                          member.posClass
                        }">${member.position.charAt(0)}</span>
                        <span class="p-name">${member.name}</span>
                    </div>
                    <div class="p-score ${scoreClass}">${displayScore}</div>
                `;
            card.appendChild(row);
          });

          card.onclick = () => openTeamModal(team);
          container.appendChild(card);
        });
      }

      // モーダルオープン
      function openTeamModal(team) {
        selectedTeam = team;
        tempScores = {};

        const tachijunText = team.tachijun ? `[立順:${team.tachijun}] ` : '';
        document.getElementById(
          'modal-team-name'
        ).textContent = `${tachijunText}${team.teamName} (${tabConfig[currentTab].label})`;

        const container = document.getElementById('modal-inputs-container');
        container.innerHTML = '';

        const maxScore = tabConfig[currentTab].max;

        team.members.forEach((member) => {
          let currentVal = member.details[currentTab];
          if (currentVal === '-' || currentVal === '') currentVal = null;
          else currentVal = Number(currentVal);

          tempScores[member.name] = currentVal;

          const wrapper = document.createElement('div');
          wrapper.className = 'input-row';

          const label = document.createElement('div');
          label.className = 'input-label';
          label.innerHTML = `<span class="p-pos ${
            member.posClass
          }">${member.position.charAt(0)}</span> ${member.name}`;
          wrapper.appendChild(label);

          const btnGroup = document.createElement('div');
          btnGroup.className = 'btn-group';

          for (let i = 0; i <= maxScore; i++) {
            const btn = document.createElement('button');
            btn.className = 'score-select-btn';
            if (currentVal === i) btn.classList.add('selected');
            btn.textContent = i;

            btn.onclick = (e) => {
              const parent = e.target.parentNode;
              Array.from(parent.children).forEach((b) =>
                b.classList.remove('selected')
              );
              e.target.classList.add('selected');
              tempScores[member.name] = i;
            };

            btnGroup.appendChild(btn);
          }
          wrapper.appendChild(btnGroup);
          container.appendChild(wrapper);
        });

        document.getElementById('modal').classList.add('open');
      }

      window.closeModal = function () {
        document.getElementById('modal').classList.remove('open');
        selectedTeam = null;
      };

      // 成績一括保存
      async function submitTeamScores() {
        if (!authKey) {
          alert('パスワード未入力のため保存できません。');
          return;
        }

        const updates = [];
        selectedTeam.members.forEach((member) => {
          const val = tempScores[member.name];
          if (val !== null && val !== undefined) {
            updates.push({
              id: selectedTeam.id,
              name: member.name,
              target: currentTab,
              score: val,
              authKey: authKey,
            });
          }
        });

        if (updates.length === 0) {
          closeModal();
          return;
        }

        showLoading(true, '保存中(0/' + updates.length + ')...');
        closeModal();

        let successCount = 0;
        let errorOccurred = false;

        for (let i = 0; i < updates.length; i++) {
          updateLoadingMsg(`保存中(${i + 1}/${updates.length})...`);

          try {
            const payload = updates[i];
            const res = await fetch(API_URL, {
              method: 'POST',
              body: JSON.stringify(payload),
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            });
            const json = await res.json();

            if (json.status === 'success') {
              updateLocalData(
                payload.id,
                payload.name,
                payload.target,
                payload.score
              );
              successCount++;
            } else {
              console.error('Save failed', json.message);
              errorOccurred = true;
            }
          } catch (e) {
            console.error(e);
            errorOccurred = true;
          }
        }

        showLoading(false);

        if (errorOccurred) {
          alert(
            `一部保存に失敗しました。\n成功: ${successCount} / ${updates.length}`
          );
        }

        renderList();
      }

      function updateLocalData(tid, pname, target, val) {
        const team = allData.find((t) => t.id === tid);
        if (team) {
          const mem = team.members.find((m) => m.name === pname);
          if (mem) mem.details[target] = val;
        }
      }

      function showLoading(show, msg = '') {
        const el = document.getElementById('loading-overlay');
        const txt = document.getElementById('loading-msg');
        el.style.display = show ? 'flex' : 'none';
        if (msg) txt.textContent = msg;
      }

      function updateLoadingMsg(msg) {
        document.getElementById('loading-msg').textContent = msg;
      }

      init();
    </script>
  </body>
</html>
